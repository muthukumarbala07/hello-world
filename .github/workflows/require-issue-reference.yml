name: Require Issue Reference in PR

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  issues: read

jobs:
  check-issue-reference:
    runs-on: ubuntu-latest
    steps:
      - name: Check for issue reference
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title;
            const prBody = context.payload.pull_request.body || '';
            const combinedText = `${prTitle} ${prBody}`;
            
            // Comprehensive regex patterns for issue references
            const patterns = [
              // Standard GitHub issue references: #123
              /#\d+/i,
              // Keywords with issue numbers: Fixes #123, Closes #123, Resolves #123
              /\b(fix(es|ed)?|close(s|d)?|resolve(s|d)?|relate(s|d)?(\s+to)?)\s+#\d+/i,
              // Full GitHub URLs: https://github.com/owner/repo/issues/123
              /https?:\/\/github\.com\/[\w-]+\/[\w-]+\/issues\/\d+/i,
              // Multiple formats: issue #123, issue: #123
              /\bissue[:\s]+#?\d+/i
            ];
            
            // Check if any pattern matches
            const hasIssueReference = patterns.some(pattern => pattern.test(combinedText));
            
            if (hasIssueReference) {
              core.info('✅ Issue reference found in PR title or body.');
              
              // Extract and display found references
              const references = combinedText.match(/#\d+|https?:\/\/github\.com\/[\w-]+\/[\w-]+\/issues\/\d+/gi) || [];
              if (references.length > 0) {
                core.info(`Found references: ${references.join(', ')}`);
              }
            } else {
              const errorMessage = [
                '❌ No issue reference found in PR title or body.',
                '',
                'Please include an issue reference using one of these formats:',
                '  • #123',
                '  • Fixes #123',
                '  • Closes #123',
                '  • Resolves #123',
                '  • Related to #123',
                '  • https://github.com/owner/repo/issues/123',
                '',
                'This helps track the relationship between PRs and issues.'
              ].join('\n');
              
              core.setFailed(errorMessage);
              
              // Add a comment to the PR with helpful information
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: '## ⚠️ Missing Issue Reference\n\n' + errorMessage
                });
              } catch (error) {
                core.warning('Could not add comment to PR: ' + error.message);
              }
            }